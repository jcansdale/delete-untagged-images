on: [push]

jobs:
  delete_untagged:
    runs-on: ubuntu-latest
    name: A job to delete untagged versions
    steps:
      # To use this repository's private action,
      # you must check out the repository
      - name: Checkout
        uses: actions/checkout@v2
      - name: Delete untagged versions step
        uses: ./ # Uses an action in the root directory
        with:
          owner: jcansdale-test
          package: kipp2
          token: ${{ secrets.DELETE_PACKAGES_TOKEN }}

  delete_alternative:
    runs-on: ubuntu-latest
    steps:

      # this should do the same thing
      - uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.DELETE_PACKAGES_TOKEN }}
          script: |
            const response = await github.request("GET /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions",
              { per_page: ${{ env.PER_PAGE }}
            });
            for(version of response.data) {
                if (version.metadata.container.tags.length == 0) {
                    console.log("delete " + version.id)
                    const deleteResponse = await github.request("DELETE /${{ env.OWNER }}/packages/container/${{ env.PACKAGE_NAME }}/versions/" + version.id, { });
                    console.log("status " + deleteResponse.status)
                }
            }
        env:
          OWNER: users/jcansdale-test
          PACKAGE_NAME: kipp2
          PER_PAGE: 1
